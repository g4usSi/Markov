<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadena de Markov - Plataforma Educativa</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Cadena de Markov - Plataforma Educativa Virtual</h1>
        
        <div class="input-section">
            <h2>Configuración</h2>
            
            <div class="form-group">
                <label>Estados (separados por coma):</label>
                <input type="text" id="states" value="Activo,Inactivo,Desconectado">
            </div>
            
            <div class="form-group">
                <label>Estado Inicial:</label>
                <select id="initialState">
                    <option value="0">Activo</option>
                    <option value="1">Inactivo</option>
                    <option value="2">Desconectado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Número de Pasos (n):</label>
                <input type="number" id="steps" value="5" min="1" max="20">
            </div>
            
            <h3>Matriz de Transición (P)</h3>
            <div id="matrixContainer"></div>
            
            <button onclick="calculate()">Calcular P^n</button>
        </div>
        
        <div id="results" class="results-section" style="display:none;">
            <h2>Resultados</h2>
            
            <div class="result-box">
                <h3>Matriz P^n</h3>
                <table id="resultMatrix"></table>
            </div>
            
            <div class="result-box">
                <h3>Probabilidades después de n pasos</h3>
                <table id="probTable"></table>
            </div>
        </div>
    </div>

    <script>
        const defaultMatrix = [
            [0.7, 0.2, 0.1],
            [0.3, 0.4, 0.3],
            [0.1, 0.1, 0.8]
        ];

        function createMatrix() {
            const states = document.getElementById('states').value.split(',').map(s => s.trim());
            const n = states.length;
            const container = document.getElementById('matrixContainer');
            container.innerHTML = '';

            let html = '<table class="matrix-input">';
            html += '<tr><th>De/A</th>';
            states.forEach(s => html += `<th>${s}</th>`);
            html += '</tr>';

            for (let i = 0; i < n; i++) {
                html += `<tr><th>${states[i]}</th>`;
                for (let j = 0; j < n; j++) {
                    html += `<td><input type="number" step="0.01" min="0" max="1" 
                             id="cell_${i}_${j}" value="${defaultMatrix[i][j]}" 
                             onchange="validateRow(${i})"></td>`;
                }
                html += '</tr>';
            }
            html += '</table>';
            container.innerHTML = html;
        }

        function validateRow(row) {
            const states = document.getElementById('states').value.split(',').length;
            let sum = 0;
            for (let j = 0; j < states; j++) {
                const cell = document.getElementById(`cell_${row}_${j}`);
                sum += parseFloat(cell.value) || 0;
            }
            if (!isNaN(sum) && Math.abs(sum - 1.0) > 0.001) {
                console.warn(`Fila ${row} suma ${sum.toFixed(3)}, debe sumar 1.0`);
            }
        }

        function getMatrix() {
            const states = document.getElementById('states').value.split(',').map(s => s.trim());
            const n = states.length;
            const matrix = [];

            for (let i = 0; i < n; i++) {
                const row = [];
                for (let j = 0; j < n; j++) {
                    const val = parseFloat(document.getElementById(`cell_${i}_${j}`).value) || 0;
                    row.push(val);
                }
                matrix.push(row);
            }
            return matrix;
        }

        async function calculate() {
            const matrix = getMatrix();
            const initialState = document.getElementById('initialState').value;
            const steps = document.getElementById('steps').value;
            const states = document.getElementById('states').value.split(',').map(s => s.trim());

            try {
                const response = await fetch('/calculate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        matrix: matrix,
                        initial_state: initialState,
                        steps: steps,
                        states: states
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayResults(result.P_n, result.probabilities, result.states);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error);
            }
        }

        function displayResults(P_n, probs, states) {
            // Mostrar matriz P^n
            let matrixHtml = '<tr><th>De/A</th>';
            states.forEach(s => matrixHtml += `<th>${s}</th>`);
            matrixHtml += '</tr>';

            for (let i = 0; i < P_n.length; i++) {
                matrixHtml += `<tr><th>${states[i]}</th>`;
                for (let j = 0; j < P_n[i].length; j++) {
                    matrixHtml += `<td>${P_n[i][j].toFixed(4)}</td>`;
                }
                matrixHtml += '</tr>';
            }
            document.getElementById('resultMatrix').innerHTML = matrixHtml;

            // Mostrar probabilidades finales
            let probHtml = '<tr><th>Estado</th><th>Probabilidad</th><th>Porcentaje</th></tr>';
            probs.forEach((p, i) => {
                probHtml += `<tr><td>${states[i]}</td><td>${p.toFixed(4)}</td><td>${(p*100).toFixed(2)}%</td></tr>`;
            });
            document.getElementById('probTable').innerHTML = probHtml;

            document.getElementById('results').style.display = 'block';
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', createMatrix);
        document.getElementById('states').addEventListener('change', createMatrix);
    </script>
</body>
</html>